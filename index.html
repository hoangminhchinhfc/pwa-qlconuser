<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#317EFB"/>
  <link rel="manifest" href="manifest.json">
  <title>Qu·∫£n L√Ω Con - Ng∆∞·ªùi D√πng </title>
 <style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #74ebd5, #ACB6E5);
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column; /* s·∫Øp x·∫øp theo c·ªôt */
    align-items: center; /* cƒÉn gi·ªØa ngang */
    min-height: 100vh;
  }

  .container {
    background: #fff;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    width: 360px;
    animation: fadeIn 0.5s ease-in-out;
  }

  h1, h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #2d3436;
  }

  .form-group {
    margin-bottom: 15px;
  }

  label {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
    color: #555;
  }

  input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
    outline: none;
    font-size: 14px;
    transition: all 0.3s ease;
    background: #fdfdfd;
  }

  input:focus {
    border-color: #6a11cb;
    box-shadow: 0 0 5px rgba(106, 17, 203, 0.3);
  }

  button {
    padding: 10px;
    background: linear-gradient(90deg, #6a11cb, #2575fc);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  button:hover {
    background: linear-gradient(90deg, #2575fc, #6a11cb);
    transform: scale(1.05);
  }

  /* N√∫t tr√™n c√πng 1 h√†ng */
  .button-row {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }

  .button-row button {
    flex: 1; /* M·ªói n√∫t r·ªông ƒë·ªÅu nhau */
  }

  #ketQua {
    text-align: center;
    margin-top: 10px;
    color: #e84118;
    font-weight: bold;
  }

  ul {
    list-style: none;
    padding: 0;
  }

  ul li {
    background: #f7f9fa;
    margin: 5px 0;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #eee;
    font-size: 14px;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

</head>
<body>

<div class="container" id="loginForm">
  <h1>üîë ƒêƒÉng Nh·∫≠p</h1>
  <div class="form-group">
    <label for="checkUserName">Email ƒêƒÉng Nh·∫≠p</label>
    <input type="text" id="checkUserName" placeholder="Nh·∫≠p username...">
  </div>
  <div class="form-group">
    <label for="checkPassword">M·∫≠t kh·∫©u</label>
    <input type="password" id="checkPassword" placeholder="Nh·∫≠p password...">
  </div>
  <button onclick="dangNhapTuFirebase()">ƒêƒÉng nh·∫≠p</button>
  <p id="ketQua"></p>
</div>



 <div class="container"  >
  <div id="welcomeUser" style="margin-bottom:15px; font-weight:bold; font-size:18px; color:#2c3e50;"></div>
  <h3>‚öô Th√¥ng tin Config</h3>
<h2> Danh S√°ch c√°c ch∆∞∆°ng tr√¨nh b·ªã gi·ªõi h·∫°n th·ªùi gian </h2>
</div>


<div class="container" id="userInfo" style="display:none;">

  <div style="display: flex; gap: 10px;">
      <button id="btnStopPC">T·∫Øt M√°y T√≠nh T·ª´ Xa</button>
      <button id="btnChat">N√≥i Chuy·ªán v·ªõi M√°y Con</button>
  </div>

  <ul id="configInfo"></ul>

  <!-- N√∫t ·ªü gi·ªØa -->
  <div style="text-align: center; margin-top: 15px;">
      <button onclick="dangXuat()" style="width: auto; min-width: 140px;">
    
 	<span style="font-size: 2rem;">üö™</span> ƒêƒÉng xu·∫•t
      </button>
  </div>

  <h3></h3>

  <div style="text-align: center; margin-top: 10px;">
      <button id="a2hsBtn" style="width: auto; min-width: 200px;">
  	<span style="font-size: 2rem;">üì≤</span> Th√™m v√†o m√†n h√¨nh ch√≠nh
      
      </button>
  </div>

</div>








<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>


var firebaseConfig = {
  apiKey: "AIzaSyCoOFo_pN6dvjJr_PDx88VULeGXh0pj3xU",
  authDomain: "myqlcon.firebaseapp.com",
  databaseURL: "https://myqlcon-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "myqlcon",
  storageBucket: "myqlcon.appspot.com",
  messagingSenderId: "115813241978",
  appId: "1:115813241978:web:2a2567a437dd7c684857c3"
};
firebase.initializeApp(firebaseConfig);

let currentUserRef = null;
 console.log("UID hi·ªán t·∫°i: trong h√†m hi·ªÉn th·ªã User ID");
document.addEventListener("DOMContentLoaded", function () {
  firebase.auth().onAuthStateChanged(function (user) {
    if (user) {
      // ƒê√£ ƒëƒÉng nh·∫≠p -> t·∫£i d·ªØ li·ªáu c·ªßa user
      console.log("ƒê√£ ƒëƒÉng nh·∫≠p v·ªõi UID:", user.uid);
     console.log("UID hi·ªán t·∫°i: " + user.uid);
      hienThiUserTheoUID(user.uid);
console.warn("Ch√≠nh UID hi·ªán t·∫°i: trong h√†m hi·ªÉn th·ªã User ID");

    } else {
      console.warn("‚ö† Ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c session h·∫øt h·∫°n!");
      console.log("Ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c session h·∫øt h·∫°n!");
      // V√≠ d·ª•: Chuy·ªÉn v·ªÅ trang login
      // window.location.href = "login.html";
    }
  });
});



function hienThiUserTheoUID(uid) {
  document.getElementById("loginForm").style.display = "none";
  document.getElementById("userInfo").style.display = "block";

  // B·∫Øt ƒë·∫ßu l·∫Øng nghe realtime cho user n√†y
  listenUserRealtime(uid);
      console.log("UID hi·ªán t·∫°i: trong h√†m hi·ªÉn th·ªã User ID");
}

// H√†m t·∫°o listener realtime cho user
function listenUserRealtime(uid) {
  if (currentUserRef) {
    currentUserRef.off();
  }

  currentUserRef = firebase.database().ref("users/" + uid);
  currentUserRef.on("value", function (snapshot) {
    const userData = snapshot.val();
    if (userData) {
      console.log("üìå D·ªØ li·ªáu user:", userData);
      hienThiUser(userData);
      hienThiConfigUser(userData);
      localStorage.setItem("loggedUser", JSON.stringify(userData));
    } else {
      console.warn("‚ö† Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu user:", uid);
    }
  });
}



function dangNhapTuFirebase() {
  var email = document.getElementById("checkUserName").value.trim();
  var password = document.getElementById("checkPassword").value.trim();
  var ketQuaElem = document.getElementById("ketQua");

  if (!email || !password) {
    ketQuaElem.innerText = "‚ö† Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.";
    return;
  }

  firebase.auth().signInWithEmailAndPassword(email, password)
    .then((userCredential) => {
      ketQuaElem.innerText = "‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!";
      const user = userCredential.user;
      hienThiUserTheoUID(user.uid);
 console.log("a ƒë·∫øn hi·ªÉn thi config");
    })
    .catch((error) => {
      ketQuaElem.innerText = "‚ùå " + error.message;
    });
}
function hienThiUser(userData) {
  // Hi·ªÉn th·ªã t√™n v√† email
  const welcomeElem = document.getElementById("welcomeUser");
  welcomeElem.innerHTML = `üëã Xin ch√†o <b>${userData.UserName}</b><br>üìß ${userData.Email}`;

  // L·∫•y UID hi·ªán t·∫°i t·ª´ Firebase Auth
  const currentUser = firebase.auth().currentUser;
  if (!currentUser) {
    alert("Kh√¥ng t√¨m th·∫•y UID ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
    return;
  }
  const uid = currentUser.uid;

  const btnStopPC = document.getElementById("btnStopPC");
  let stopPCState = false; // l∆∞u tr·∫°ng th√°i hi·ªán t·∫°i t·ª´ realtime

  // ====== L·∫Øng nghe StopPC realtime ======
  firebase.database()
    .ref(`/users/${uid}/Config/StopPC`)
    .on("value", snapshot => {
      stopPCState = snapshot.val() === true;
      btnStopPC.textContent = stopPCState ? "B·ªè T·∫Øt M√°y T√≠nh" : "T·∫Øt M√°y T√≠nh";
    });

  // ====== N√∫t Toggle StopPC ======
  btnStopPC.addEventListener("click", async () => {
    try {
      if (stopPCState) {
        // H·ªßy StopPC
        await firebase.database()
          .ref(`/users/${uid}/Config/StopPC`)
          .set(false);
      } else {
        // B·∫≠t StopPC
        await firebase.database()
          .ref(`/users/${uid}/Config/StopPC`)
          .set(true);

        // Sau 5 ph√∫t t·ª± ƒë·ªông t·∫Øt StopPC
        setTimeout(async () => {
          await firebase.database()
            .ref(`/users/${uid}/Config/StopPC`)
            .set(false);
        }, 5 * 60 * 1000);
      }
    } catch (err) {
      alert("‚ùå L·ªói khi x·ª≠ l√Ω l·ªánh: " + err.message);
    }
  });
}





function hienThiConfigUser(userData) {
  let configList = document.getElementById("configInfo");
  configList.innerHTML = "";

  if (!userData.Config) {
    configList.innerHTML = "<li>Ch∆∞a c√≥ c·∫•u h√¨nh n√†o.</li>";
    return;
  }

  const propLabels = {
    CooldownMinutes: "Th·ªùi gian ch·ªù s·ª≠ d·ª•ng l·∫°i sau d·ª´ng",
    CurrentSessionMinutes: "Th·ªùi gian s·ª≠ d·ª•ng hi·ªán t·∫°i",
    LaunchesToday: "S·ªë l·∫ßn s·ª≠ d·ª•ng h√¥m nay",
    MaxLaunchesPerDay: "Gi·ªõi h·∫°n s·ªë l·∫ßn s·ª≠ d·ª•ng 1 ng√†y",
    MaxMinutes: "Th·ªùi gian t·ªëi ƒëa m·ªói l·∫ßn",
    Name: "T√™n ph·∫ßn m·ªÅm",
    UsedMinutesToday: "T·ªïng th·ªùi gian s·ª≠ d·ª•ng h√¥m nay",
    TempStop: "T·∫°m d·ª´ng",
    StartHour: "Gi·ªù b·∫Øt ƒë·∫ßu",
    EndHour: "Gi·ªù k·∫øt th√∫c"
  };

  const allKeys = Object.keys(userData.Config);
  const otherKeys = allKeys.filter(k => k !== "GamesAllowed");
  const finalKeys = [...otherKeys, "GamesAllowed"];

  finalKeys.forEach((key) => {
    let value = userData.Config[key];

    // N·∫øu l√† m·∫£ng (GamesAllowed)
    if (Array.isArray(value)) {
      let li = document.createElement("li");
      li.innerHTML = `<strong>${propLabels[key] || key}:</strong>`;
      let subList = document.createElement("div");
      subList.style.marginLeft = "15px";

      value.forEach((item, index) => {
        let gameBox = document.createElement("div");
        gameBox.style.background = "#fff";
        gameBox.style.padding = "10px";
        gameBox.style.margin = "10px 0";
        gameBox.style.borderRadius = "8px";
        gameBox.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";

        let gameTitle = document.createElement("div");
        gameTitle.textContent = `${index + 1}. ${item.Name || "Kh√¥ng t√™n"}`;
        gameTitle.style.fontWeight = "bold";
        gameTitle.style.marginBottom = "6px";
        gameBox.appendChild(gameTitle);

        // Hi·ªÉn th·ªã c√°c thu·ªôc t√≠nh
        for (let prop in item) {
          let attr = document.createElement("div");
          attr.textContent = `${propLabels[prop] || prop}: ${item[prop]}`;
          attr.style.fontSize = "14px";
          attr.style.margin = "2px 0";
          gameBox.appendChild(attr);
        }

        // N√∫t thao t√°c
        let btnContainer = document.createElement("div");
        btnContainer.style.marginTop = "8px";

        let currentUID = firebase.auth().currentUser?.uid || "";

        // C·∫≠p nh·∫≠t
        let btnUpdate = document.createElement("button");
        btnUpdate.textContent = "C·∫≠p nh·∫≠t";
        btnUpdate.style.marginRight = "6px";
        btnUpdate.onclick = () => {
          const params = new URLSearchParams({ uid: currentUID, key, index });
          window.location.href = `update.html?${params.toString()}`;
        };

        // X√≥a
        let btnDelete = document.createElement("button");
        btnDelete.textContent = "X√≥a";
        btnDelete.style.marginRight = "6px";
        btnDelete.onclick = () => {
          if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a game n√†y?")) return;
          let path = `users/${currentUID}/Config/${key}`;
          firebase.database().ref(path).once("value").then(snapshot => {
            let arr = Object.values(snapshot.val() || []);
            arr.splice(index, 1);
            return firebase.database().ref(path).set(arr);
          }).then(() => {
            alert("‚úÖ ƒê√£ x√≥a th√†nh c√¥ng!");
          }).catch(err => {
            alert("‚ùå L·ªói khi x√≥a: " + err.message);
          });
        };

        // D·ª´ng/Ch·∫°y l·∫°i
        let btnStop = document.createElement("button");
        let isStopped = item.TempStop === true;
        updateStopBtn(btnStop, isStopped);

        btnStop.onclick = async () => {
          if (!isStopped) {
            await firebase.database().ref(`users/${currentUID}/Config/${key}/${index}/TempStop`).set(true);
            isStopped = true;
            updateStopBtn(btnStop, true);
            setTimeout(async () => {
              await firebase.database().ref(`users/${currentUID}/Config/${key}/${index}/TempStop`).set(false);
              isStopped = false;
              updateStopBtn(btnStop, false);
            }, 30 * 60 * 1000);
          } else {
            await firebase.database().ref(`users/${currentUID}/Config/${key}/${index}/TempStop`).set(false);
            isStopped = false;
            updateStopBtn(btnStop, false);
          }
        };

        btnContainer.appendChild(btnUpdate);
        btnContainer.appendChild(btnDelete);
        btnContainer.appendChild(btnStop);
        gameBox.appendChild(btnContainer);
        subList.appendChild(gameBox);
      });

      li.appendChild(subList);
      configList.appendChild(li);
    }
    // N·∫øu l√† gi√° tr·ªã th∆∞·ªùng
    else {
      let li = document.createElement("li");
      li.textContent = `${propLabels[key] || key}: ${value}`;
      configList.appendChild(li);
    }
  });

  function updateStopBtn(btn, stopped) {
    if (stopped) {
      btn.textContent = "Ch·∫°y l·∫°i";
      btn.style.background = "#2980b9";
      btn.style.color = "#fff";
    } else {
      btn.textContent = "D·ª´ng ngay";
      btn.style.background = "#c0392b";
      btn.style.color = "#fff";
    }
  }
}


 
function dangXuat() {
  // T·∫Øt listener realtime khi ƒëƒÉng xu·∫•t
  if (currentUserRef) {
    currentUserRef.off();
    currentUserRef = null;
  }

  localStorage.removeItem("loggedUser");
  document.getElementById("loginForm").style.display = "block";
  document.getElementById("userInfo").style.display = "none";
}




</script>
  <script src="script.js"></script>

 <!-- ‚úÖ Script x·ª≠ l√Ω A2HS -->
  <script>
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      // NgƒÉn tr√¨nh duy·ªát hi·ªÉn th·ªã banner m·∫∑c ƒë·ªãnh
      e.preventDefault();
      deferredPrompt = e;

      // Hi·ªán n√∫t
      const btn = document.getElementById('a2hsBtn');
      btn.style.display = 'inline-block';

      btn.addEventListener('click', () => {
        // Hi·ªán h·ªôp tho·∫°i c√†i ƒë·∫∑t
        deferredPrompt.prompt();

        // Ch·ªù ng∆∞·ªùi d√πng ph·∫£n h·ªìi
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('‚úÖ Ng∆∞·ªùi d√πng ƒë√£ ch·∫•p nh·∫≠n A2HS');
          } else {
            console.log('‚ùå Ng∆∞·ªùi d√πng ƒë√£ t·ª´ ch·ªëi A2HS');
          }
          deferredPrompt = null;
        });
      });
    });
  </script>


</body>
</html>
