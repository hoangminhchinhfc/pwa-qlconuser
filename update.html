<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>C·∫≠p nh·∫≠t Config</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  body{
    font-family:Arial, sans-serif; margin:0; min-height:100vh;
    display:flex; justify-content:flex-start; align-items:center;
    background:linear-gradient(135deg,#74ebd5,#ACB6E5);
  }
  .container{
    width:100%; max-width:560px; margin:24px auto; background:#fff;
    border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.12);
    padding:24px; box-sizing:border-box;
  }
  h2{ margin:0 0 12px; }
  .muted{ color:#666; margin:4px 0 16px; }
  label{ display:block; font-weight:600; margin:14px 0 6px; }
  input,select{
    width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px;
    outline:none; box-sizing:border-box;
  }
  input:focus{ border-color:#6a11cb; }
  .btn{
    display:inline-block; width:100%; padding:12px; margin-top:16px;
    border:none; border-radius:10px; color:#fff; font-weight:600; cursor:pointer;
    background:linear-gradient(90deg,#6a11cb,#2575fc);
    transition:transform .15s ease;
  }
  .btn:hover{ transform:translateY(-1px); }
  .btn--ghost{
    background:#eef2ff; color:#3b5bdb;
  }
  .error{ color:#c0392b; font-weight:700; }
</style>
</head>
<body>
  <div class="container">
    <h2>üîß C·∫≠p nh·∫≠t Config</h2>
    <div class="muted">Trang n√†y y√™u c·∫ßu b·∫°n ƒëang ƒëƒÉng nh·∫≠p ƒë√∫ng t√†i kho·∫£n s·ªü h·ªØu UID.</div>
    <div id="formArea">ƒêang t·∫£i d·ªØ li·ªáu...</div>
  </div>

<script>
  // === Firebase config ===
  var firebaseConfig = {
    apiKey: "AIzaSyCoOFo_pN6dvjJr_PDx88VULeGXh0pj3xU",
    authDomain: "myqlcon.firebaseapp.com",
    databaseURL: "https://myqlcon-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "myqlcon",
    storageBucket: "myqlcon.appspot.com",
    messagingSenderId: "115813241978",
    appId: "1:115813241978:web:2a2567a437dd7c684857c3"
  };
  firebase.initializeApp(firebaseConfig);

  // === L·∫•y query params ===
  const qp = new URLSearchParams(window.location.search);
  const uid    = qp.get("uid");    // userName
  const device = qp.get("deviceId"); // deviceId
  const key    = qp.get("key");    // "GamesAllowed"
  const index  = qp.get("index");  // v·ªã tr√≠ ph·∫ßn t·ª≠ trong m·∫£ng

  const formArea = document.getElementById("formArea");

  if (!uid || !device || !key || index === null) {
    formArea.innerHTML = `<div class="error">
‚ùå Thi·∫øu tham s·ªë (uid/device/key/index) tr√™n URL .
‚ùå Thi·∫øu tham s·ªë tr√™n URL:<br>
      uid: ${uid || "<b style='color:red'>ch∆∞a c√≥</b>"}<br>
      device: ${device || "<b style='color:red'>ch∆∞a c√≥</b>"}<br>
      key: ${key || "<b style='color:red'>ch∆∞a c√≥</b>"}<br>
      index: ${(index !== null) ? index : "<b style='color:red'>ch∆∞a c√≥</b>"}
</div>`;
  } else {
    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        formArea.innerHTML = `
          <div class="error">‚ö† B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.</div>
          <button class="btn btn--ghost" onclick="window.location.href='./'">‚¨Ö Quay l·∫°i</button>
        `;
        return;
      }

      if (user.uid !== uid) {
        formArea.innerHTML = `
          <div class="error">‚õî Kh√¥ng c√≥ quy·ªÅn. UID hi·ªán t·∫°i (${user.uid}) kh√°c UID tr√™n URL (${uid}).</div>
          <button class="btn btn--ghost" onclick="history.back()">‚¨Ö Quay l·∫°i</button>
        `;
        return;
      }

      // ƒë∆∞·ªùng d·∫´n t·ªõi item c·∫ßn s·ª≠a
      const refPath = `users/${uid}/devices/${device}/Config/${key}/${index}`;
      const itemRef = firebase.database().ref(refPath);

      try {
        const snap = await itemRef.once("value");
        const data = snap.val();
        if (!data) {
          formArea.innerHTML = `<div class="error">‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu t·∫°i <code>${refPath}</code>.</div>`;
          return;
        }
        // render form
        renderForm(data, refPath);
      } catch (err) {
        formArea.innerHTML = `<div class="error">‚ùå L·ªói ƒë·ªçc d·ªØ li·ªáu: ${err.message}</div>`;
      }
    });
  }

  // === Render form + Save ===
  function renderForm(data, refPath){
    formArea.innerHTML = "";

    const inputs = {};
    const isBool = v => typeof v === "boolean";
    const isNum  = v => typeof v === "number";

    Object.keys(data).forEach((prop) => {
      const label = document.createElement("label");
      label.textContent = prop;
      formArea.appendChild(label);

      let input;
      if (isBool(data[prop])) {
        input = document.createElement("input");
        input.type = "checkbox";
        input.checked = !!data[prop];
      } else {
        input = document.createElement("input");
        input.type = isNum(data[prop]) ? "number" : "text";
        input.value = data[prop];
      }

      input.dataset.type = isBool(data[prop]) ? "bool" : (isNum(data[prop]) ? "number" : "string");
      inputs[prop] = input;
      formArea.appendChild(input);
    });

    // N√∫t l∆∞u
    const saveBtn = document.createElement("button");
    saveBtn.className = "btn";
    saveBtn.textContent = "üíæ L∆∞u thay ƒë·ªïi";
    saveBtn.onclick = async () => {
      const updates = {};
      Object.keys(inputs).forEach((prop) => {
        const t = inputs[prop].dataset.type;
        let val;
        if (t === "bool")      val = inputs[prop].checked;
        else if (t === "number") val = Number(inputs[prop].value);
        else                    val = inputs[prop].value;
        updates[`${refPath}/${prop}`] = val;
      });

      try {
        await firebase.database().ref().update(updates);
        saveBtn.textContent = "‚úÖ ƒê√£ c·∫≠p nh·∫≠t!";
        saveBtn.style.background = "linear-gradient(135deg,#2ecc71,#27ae60)";
        setTimeout(()=> window.location.href = "./", 1200);
      } catch (err) {
        saveBtn.textContent = "‚ùå " + err.message;
        saveBtn.style.background = "linear-gradient(135deg,#e74c3c,#c0392b)";
      }
    };
    formArea.appendChild(saveBtn);

    // N√∫t quay l·∫°i
    const backBtn = document.createElement("button");
    backBtn.className = "btn btn--ghost";
    backBtn.textContent = "‚¨Ö Quay l·∫°i";
    backBtn.onclick = () => history.back();
    formArea.appendChild(backBtn);
  }
</script>
</body>
</html>
